<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Agent - Interactive Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'JetBrains Mono', 'Courier New', monospace; background: #1a1a2e; color: #eee; }
        
        .header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid #0f3460;
        }
        .header h1 { font-size: 16px; color: #e94560; }
        .header .status { font-size: 12px; color: #4ecca3; }
        
        .main {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: calc(100vh - 50px);
        }
        
        .sidebar {
            background: #16213e;
            padding: 16px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }
        .sidebar h3 { font-size: 11px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        .model-list { list-style: none; }
        .model-list li {
            padding: 8px 12px;
            margin: 4px 0;
            background: #1a1a2e;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        .model-list li:hover { background: #0f3460; }
        .model-list li.active { background: #e94560; color: white; }
        
        .viewer-container {
            position: relative;
            background: #0a0a1a;
        }
        #viewer-3d { width: 100%; height: 100%; }
        
        .controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 400px;
        }
        .controls button {
            background: rgba(22, 33, 62, 0.95);
            color: #eee;
            border: 1px solid #0f3460;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .controls button:hover { background: #e94560; border-color: #e94560; }
        .controls button.active { background: #4ecca3; border-color: #4ecca3; color: #1a1a2e; }
        
        .info-panel {
            background: #16213e;
            padding: 16px;
            overflow-y: auto;
            border-left: 1px solid #0f3460;
        }
        .info-panel h3 { font-size: 11px; color: #888; margin: 16px 0 8px; text-transform: uppercase; letter-spacing: 1px; }
        .info-panel .value { font-size: 12px; color: #4ecca3; margin: 2px 0; }
        .info-panel .dim { font-size: 11px; color: #ccc; padding: 3px 0; }
        
        /* Dimension Sliders */
        .dimension-slider {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 4px;
            margin: 6px 0;
        }
        .dimension-slider label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #aaa;
            margin-bottom: 4px;
        }
        .dimension-slider label span { color: #4ecca3; }
        .dimension-slider input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #0f3460;
            border-radius: 3px;
            outline: none;
        }
        .dimension-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #e94560;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Part Selection */
        .part-list { margin-top: 8px; }
        .part-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            margin: 4px 0;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .part-item:hover { border-color: #0f3460; }
        .part-item.selected { border-color: #e94560; background: rgba(233, 69, 96, 0.1); }
        .part-item input[type="checkbox"] { accent-color: #e94560; }
        
        /* AI Feedback Panel */
        .ai-feedback {
            background: #1a1a2e;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
        }
        .ai-feedback textarea {
            width: 100%;
            height: 80px;
            background: #0a0a1a;
            color: #eee;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 8px;
            font-family: inherit;
            font-size: 11px;
            resize: vertical;
        }
        .ai-feedback button {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .ai-feedback button:hover { background: linear-gradient(135deg, #c73e54, #a63344); }
        .ai-response {
            margin-top: 10px;
            padding: 10px;
            background: #0a0a1a;
            border-radius: 4px;
            font-size: 11px;
            color: #4ecca3;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .code-input { margin-top: 16px; }
        .code-input textarea {
            width: 100%;
            height: 100px;
            background: #0a0a1a;
            color: #4ecca3;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 8px;
            font-family: inherit;
            font-size: 11px;
            resize: vertical;
        }
        .code-input button {
            margin-top: 8px;
            width: 100%;
            padding: 10px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e94560;
            font-size: 14px;
            background: rgba(10,10,26,0.9);
            padding: 20px;
            border-radius: 8px;
        }
        
        .render-gallery {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
        }
        .render-gallery img {
            width: 100%;
            border-radius: 4px;
            border: 1px solid #0f3460;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .render-gallery img:hover { border-color: #e94560; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß CAD Agent</h1>
        <span class="status" id="status>
    </div>
    
    ">Connecting...</span<div class="main">
        <!-- Left Sidebar - Models & Code -->
        <div class="sidebar">
            <h3>Models</h3>
            <ul class="model-list" id="model-list"></ul>
            
            <div class="code-input">
                <h3>Create Model</h3>
                <textarea id="code-input" placeholder="from build123d import *&#10;result = Box(30, 20, 10)"></textarea>
                <button onclick="createModel()">‚ñ∂ Execute Code</button>
            </div>
        </div>
        
        <!-- Center - 3D Viewer -->
        <div class="viewer-container">
            <canvas id="viewer-3d"></canvas>
            <div class="loading" id="loading">Drop STL or create model</div>
            <div class="controls">
                <button onclick="resetView()">‚ü≤ Reset</button>
                <button onclick="toggleWireframe()">‚ó´ Wire</button>
                <button onclick="renderViews()">üìê Views</button>
                <button onclick="exportSTL()">‚¨á STL</button>
                <button onclick="exportSTEP()">‚¨á STEP</button>
                <button onclick="analyzeModel()">üîç Analyze</button>
                <button onclick="selectMode()" id="select-btn">üëÜ Select Part</button>
            </div>
        </div>
        
        <!-- Right Panel - Dimensions, Parts, AI Feedback -->
        <div class="info-panel">
            <h3>Geometry</h3>
            <div id="geometry-info">
                <div class="value">No model loaded</div>
            </div>
            
            <h3>Adjust Dimensions</h3>
            <div id="dimension-sliders"></div>
            
            <h3>Parts</h3>
            <div class="part-list" id="part-list">
                <div class="dim">No parts detected</div>
            </div>
            
            <h3>AI Feedback</h3>
            <div class="ai-feedback">
                <textarea id="ai-feedback" placeholder="Tell the AI what to change:&#10;- Move the hole 5mm right&#10;- Make the box taller&#10;- Add a fillet to the edge"></textarea>
                <button onclick="sendToAI()">ü§ñ Send to AI</button>
                <div class="ai-response" id="ai-response"></div>
            </div>
            
            <h3>Renders</h3>
            <div class="render-gallery" id="render-gallery"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/STLLoader.js"></script>
    
    <script>
        const API_BASE = window.location.origin;
        let scene, camera, renderer, controls, currentMesh;
        let wireframeMode = false;
        let selectMode = false;
        let selectedPart = null;
        let dimensionValues = {};
        
        // ============ THREE.JS SETUP ============
        function initViewer() {
            const canvas = document.getElementById('viewer-3d');
            const container = canvas.parentElement;
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a);
            
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 10000);
            camera.position.set(100, 100, 100);
            
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            
            const dirLight1 = new THREE.DirectionalLight(0xffffff, 1.2);
            dirLight1.position.set(1, 1, 1);
            scene.add(dirLight1);
            
            const dirLight2 = new THREE.DirectionalLight(0x4488ff, 0.6);
            dirLight2.position.set(-1, -1, 0);
            scene.add(dirLight2);
            
            const dirLight3 = new THREE.DirectionalLight(0xff8844, 0.3);
            dirLight3.position.set(0, -1, 1);
            scene.add(dirLight3);
            
            // Grid
            const grid = new THREE.GridHelper(200, 20, 0x333355, 0x222244);
            grid.rotation.x = Math.PI / 2;
            scene.add(grid);
            
            const axes = new THREE.AxesHelper(50);
            scene.add(axes);
            
            window.addEventListener('resize', onResize);
            animate();
            checkServer();
        }
        
        function onResize() {
            const canvas = document.getElementById('viewer-3d');
            const container = canvas.parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // ============ MODEL LOADING ============
        function loadSTL(data) {
            if (currentMesh) scene.remove(currentMesh);
            
            const loader = new THREE.STLLoader();
            const geometry = loader.parse(data);
            geometry.computeVertexNormals();
            
            const material = new THREE.MeshPhongMaterial({
                color: 0x6488aa,
                specular: 0x111111,
                shininess: 50,
                wireframe: wireframeMode
            });
            
            currentMesh = new THREE.Mesh(geometry, material);
            
            // Center
            geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            geometry.boundingBox.getCenter(center);
            currentMesh.position.sub(center);
            
            scene.add(currentMesh);
            
            // Click handler for part selection
            currentMesh.geometry.groups.forEach((group, idx) => {
                group.materialIndex = idx;
            });
            
            fitCameraToMesh();
            document.getElementById('loading').style.display = 'none';
        }
        
        function fitCameraToMesh() {
            if (!currentMesh) return;
            const box = new THREE.Box3().setFromObject(currentMesh);
            const size = new THREE.Vector3();
            box.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);
            camera.position.set(maxDim * 2, maxDim * 2, maxDim * 2);
            controls.target.set(0, 0, 0);
        }
        
        // ============ INTERACTION ============
        function resetView() {
            fitCameraToMesh();
        }
        
        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            if (currentMesh) {
                currentMesh.material.wireframe = wireframeMode;
            }
        }
        
        function selectMode() {
            selectMode = !selectMode;
            document.getElementById('select-btn').classList.toggle('active', selectMode);
            
            if (selectMode) {
                renderer.domElement.style.cursor = 'crosshair';
            } else {
                renderer.domElement.style.cursor = 'default';
            }
        }
        
        // Click handler for part selection
        renderer.domElement.addEventListener('click', (event) => {
            if (!selectMode || !currentMesh) return;
            
            const rect = renderer.domElement.getBoundingClientRect();
            const mouse = new THREE.Vector2(
                ((event.clientX - rect.left) / rect.width) * 2 - 1,
                -((event.clientY - rect.top) / rect.height) * 2 + 1
            );
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObject(currentMesh);
            if (intersects.length > 0) {
                const face = intersects[0].face;
                const partName = `Part ${face.materialIndex + 1}`;
                
                // Update selection UI
                selectedPart = partName;
                updatePartSelectionUI(partName);
            }
        });
        
        function updatePartSelectionUI(partName) {
            const list = document.getElementById('part-list');
            list.innerHTML = `
                <div class="part-item selected">
                    <input type="checkbox" checked>
                    <span>${partName}</span>
                </div>
            `;
        }
        
        // ============ API CALLS ============
        async function checkServer() {
            try {
                const resp = await fetch(`${API_BASE}/health`);
                if (resp.ok) {
                    document.getElementById('status').textContent = '‚óè Connected';
                    document.getElementById('status').style.color = '#4ecca3';
                    loadModels();
                }
            } catch (e) {
                document.getElementById('status').textContent = '‚óã Disconnected';
                document.getElementById('status').style.color = '#e94560';
            }
        }
        
        async function loadModels() {
            try {
                const resp = await fetch(`${API_BASE}/model/list`);
                const data = await resp.json();
                const list = document.getElementById('model-list');
                list.innerHTML = '';
                
                for (const model of (data.models || [])) {
                    const li = document.createElement('li');
                    li.textContent = model.name + (model.active ? ' ‚óè' : '');
                    li.className = model.active ? 'active' : '';
                    li.onclick = () => selectModel(model.name);
                    list.appendChild(li);
                }
            } catch (e) { console.error(e); }
        }
        
        async function selectModel(name) {
            try {
                // Get measurements
                const measureResp = await fetch(`${API_BASE}/model/${name}/measure`);
                const measurements = await measureResp.json();
                updateGeometryInfo(measurements);
                
                // Get dimensions for sliders
                const dimResp = await fetch(`${API_BASE}/model/${name}/dimensions`);
                const dims = await dimResp.json();
                updateDimensionSliders(dims);
                
                // Export and load STL
                const exportResp = await fetch(`${API_BASE}/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, format: 'stl' })
                });
                const stlData = await exportResp.arrayBuffer();
                loadSTL(stlData);
                
                loadModels();
            } catch (e) { console.error(e); }
        }
        
        async function createModel() {
            const code = document.getElementById('code-input').value;
            if (!code.trim()) return;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Creating...';
            
            try {
                const resp = await fetch(`${API_BASE}/model/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: 'interactive', code })
                });
                const result = await resp.json();
                
                if (result.success) {
                    updateGeometryInfo(result.geometry);
                    updateDimensionSliders(result.dimensions);
                    selectModel('interactive');
                } else {
                    document.getElementById('loading').textContent = 'Error: ' + (result.error || '').substring(0, 80);
                }
            } catch (e) {
                document.getElementById('loading').textContent = 'Connection error';
            }
        }
        
        async function sendToAI() {
            const feedback = document.getElementById('ai-feedback').value;
            if (!feedback.trim()) return;
            
            const responseEl = document.getElementById('ai-response');
            responseEl.textContent = 'ü§ñ Thinking...';
            
            try {
                const resp = await fetch(`${API_BASE}/ai/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        feedback,
                        selectedPart,
                        dimensions: dimensionValues
                    })
                });
                const result = await resp.json();
                
                if (result.code) {
                    document.getElementById('code-input').value = result.code;
                    responseEl.textContent = 'ü§ñ ' + (result.explanation || 'Generated new code');
                    await createModel();
                } else {
                    responseEl.textContent = 'ü§ñ ' + (result.response || result.error || 'No response');
                }
            } catch (e) {
                responseEl.textContent = 'Error: ' + e.message;
            }
        }
        
        async function analyzeModel() {
            try {
                const resp = await fetch(`${API_BASE}/model/interactive/analyze`);
                const result = await resp.json();
                
                let html = '';
                for (const issue of (result.issues || [])) {
                    const color = issue.severity === 'error' ? '#e94560' : '#ffa500';
                    html += `<div style="color:${color}">${issue.severity}: ${issue.message}</div>`;
                }
                if (!html) html = '<div class="value">No issues found</div>';
                
                document.getElementById('geometry-info').innerHTML = html;
            } catch (e) { console.error(e); }
        }
        
        async function renderViews() {
            try {
                const resp = await fetch(`${API_BASE}/render/all`, { method: 'POST' });
                const result = await resp.json();
                
                const gallery = document.getElementById('render-gallery');
                gallery.innerHTML = '';
                
                for (const [view, path] of Object.entries(result)) {
                    const img = document.createElement('img');
                    img.src = `${API_BASE}/renders/${path.split('/').pop()}`;
                    img.alt = view;
                    gallery.appendChild(img);
                }
            } catch (e) { console.error(e); }
        }
        
        async function exportSTL() { await exportFormat('stl'); }
        async function exportSTEP() { await exportFormat('step'); }
        
        async function exportFormat(format) {
            try {
                const resp = await fetch(`${API_BASE}/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ format })
                });
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `model.${format}`;
                a.click();
            } catch (e) { console.error(e); }
        }
        
        // ============ UI UPDATES ============
        function updateGeometryInfo(geometry) {
            const el = document.getElementById('geometry-info');
            if (!geometry) { el.innerHTML = '<div class="value">No geometry</div>'; return; }
            
            const bb = geometry.bounding_box || {};
            el.innerHTML = `
                <div class="dim">Width: <span class="value">${(bb.size?.[0] || 0).toFixed(1)} mm</span></div>
                <div class="dim">Depth: <span class="value">${(bb.size?.[1] || 0).toFixed(1)} mm</span></div>
                <div class="dim">Height: <span class="value">${(bb.size?.[2] || 0).toFixed(1)} mm</span></div>
                <div class="dim">Volume: <span class="value">${((geometry.volume || 0) / 1000).toFixed(2)} cm¬≥</span></div>
            `;
        }
        
        function updateDimensionSliders(dims) {
            const el = document.getElementById('dimension-sliders');
            if (!dims || !dims.parameters) { 
                el.innerHTML = '<div class="dim">No adjustable dimensions</div>';
                return;
            }
            
            dimensionValues = {};
            let html = '';
            
            for (const [name, info] of Object.entries(dims.parameters)) {
                const value = info.value || info.default || 10;
                const min = info.min || value * 0.5;
                const max = info.max || value * 1.5;
                
                dimensionValues[name] = value;
                
                html += `
                    <div class="dimension-slider">
                        <label>
                            ${name}
                            <span id="val-${name}">${value.toFixed(1)}</span>
                        </label>
                        <input type="range" min="${min}" max="${max}" value="${value}" 
                            onchange="updateDimension('${name}', this.value)"
                            oninput="updateDimension('${name}', this.value)">
                    </div>
                `;
            }
            
            html += '<button onclick="applyDimensionChanges()" style="width:100%;margin-top:8px;padding:8px;background:#4ecca3;color:#1a1a2e;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Apply Changes</button>';
            
            el.innerHTML = html;
        }
        
        function updateDimension(name, value) {
            dimensionValues[name] = parseFloat(value);
            document.getElementById(`val-${name}`).textContent = parseFloat(value).toFixed(1);
        }
        
        function applyDimensionChanges() {
            const code = document.getElementById('code-input').value;
            // This would generate new code with updated dimensions
            // For now, just send to AI with the new values
            document.getElementById('ai-feedback').value = 
                `Adjust dimensions: ${JSON.stringify(dimensionValues)}\n\n` +
                `Modify the model to use these values.`;
            sendToAI();
        }
        
        // Init
        initViewer();
    </script>
</body>
</html>
